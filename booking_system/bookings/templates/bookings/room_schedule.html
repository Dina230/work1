{% extends 'bookings/base.html' %}
{% load static %}

{% block title %}Расписание зала {{ room.name }} | Конференц-залы ООО "АлГИС"{% endblock %}

{% block extra_css %}
<style>
    .schedule-container {
        overflow-x: auto;
    }
    .time-line {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .time-slot {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 0.5rem;
        border-bottom: 1px solid #e2e8f0;
    }
    .time-label {
        min-width: 80px;
        font-weight: 500;
        color: #64748b;
    }
    .booking-card {
        flex: 1;
        background-color: #dbeafe;
        border-left: 4px solid #3b82f6;
        padding: 1rem;
        border-radius: 0.375rem;
        margin: 0.25rem 0;
    }
    .free-slot {
        flex: 1;
        background-color: #f0fdf4;
        border: 2px dashed #22c55e;
        padding: 1rem;
        border-radius: 0.375rem;
        text-align: center;
        color: #166534;
        margin: 0.25rem 0;
    }
    .room-info {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 2rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }
    .date-navigator {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    .date-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        background: white;
        border-radius: 0.375rem;
        color: #64748b;
        text-decoration: none;
        transition: all 0.2s;
    }
    .date-btn:hover {
        border-color: #3b82f6;
        color: #3b82f6;
    }
    .date-btn.active {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }
</style>
{% endblock %}

{% block content %}
<!-- Хлебные крошки -->
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'bookings:index' %}" class="text-decoration-none">Главная</a></li>
                <li class="breadcrumb-item"><a href="{% url 'bookings:schedule' %}" class="text-decoration-none">Календарь</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ room.name }}</li>
            </ol>
        </nav>
    </div>
</div>

<!-- Информация о зале -->
<div class="room-info">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h2 class="fw-semibold mb-2">{{ room.name }}</h2>
            <div class="d-flex gap-4 flex-wrap">
                <div>
                    <i class="bi bi-people me-2"></i>
                    <span>Вместимость: <strong>{{ room.capacity }} чел.</strong></span>
                </div>
                <div>
                    <i class="bi bi-geo-alt me-2"></i>
                    <span>{{ room.location }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <div class="d-flex gap-2 justify-content-md-end">
                {% if user.role == 'requester' %}
                    <a href="{% url 'bookings:create_booking' %}?room={{ room.id }}" 
                       class="btn btn-light">
                        <i class="bi bi-plus-circle me-2"></i>
                        Забронировать
                    </a>
                {% endif %}
                <a href="{% url 'bookings:schedule' %}?room={{ room.id }}" 
                   class="btn btn-outline-light">
                    <i class="bi bi-calendar-week me-2"></i>
                    Общий календарь
                </a>
            </div>
        </div>
    </div>
    {% if room.description %}
        <p class="mt-3 mb-0 text-white-50">{{ room.description }}</p>
    {% endif %}
</div>

<!-- Навигация по датам -->
<div class="date-navigator">
    <a href="?date={{ prev_date|date:'Y-m-d' }}" class="date-btn">
        <i class="bi bi-chevron-left"></i>
    </a>
    
    <span class="fw-semibold">{{ selected_date|date:"d E Y" }}</span>
    
    <a href="?date={{ next_date|date:'Y-m-d' }}" class="date-btn">
        <i class="bi bi-chevron-right"></i>
    </a>
</div>

<!-- Расписание на день -->
<div class="row">
    <div class="col-12">
        <div class="border rounded-3 bg-white p-4">
            <h5 class="fw-semibold mb-4">
                <i class="bi bi-calendar-day text-primary me-2"></i>
                Расписание на {{ selected_date|date:"d.m.Y" }}
                {% if bookings %}
                    <span class="badge bg-primary ms-2">{{ bookings|length }} бронирований</span>
                {% endif %}
            </h5>

            {% if bookings %}
                <div class="schedule-container">
                    <div class="time-line">
                        {% for hour in "0123456789"|make_list %}
                            {% with hour_value=forloop.counter0|add:7 %}
                                {% if hour_value <= 16 %}
                                    <div class="time-slot">
                                        <div class="time-label">
                                            {{ hour_value }}:00
                                            {% if hour_value == 16 %}
                                                <br><small class="text-muted">до 16:30</small>
                                            {% endif %}
                                        </div>
                                        {% for booking in bookings %}
                                            {% if booking.start_time.hour == hour_value %}
                                                <div class="booking-card" 
                                                     onclick="location.href='{% url 'bookings:booking_detail' booking.id %}'"
                                                     style="cursor: pointer;">
                                                    <div class="fw-semibold">{{ booking.title }}</div>
                                                    <div class="small text-primary">
                                                        {{ booking.start_time|date:"H:i" }} - {{ booking.end_time|date:"H:i" }}
                                                    </div>
                                                    <div class="small text-secondary">
                                                        <i class="bi bi-person me-1"></i>
                                                        {{ booking.requester.get_full_name|default:booking.requester.username }}
                                                    </div>
                                                    <div class="small text-secondary">
                                                        <i class="bi bi-people me-1"></i>
                                                        {{ booking.participants_count }} чел.
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                        {% if not bookings|dictsort:"start_time.hour"|slice:":1" %}
                                            {% if hour_value != 16 %}
                                                <div class="free-slot">
                                                    <i class="bi bi-check-circle me-2"></i>
                                                    Свободно
                                                    {% if user.role == 'requester' %}
                                                        <a href="{% url 'bookings:create_booking' %}?room={{ room.id }}&date={{ selected_date|date:'Y-m-d' }}&start={{ hour_value }}:00" 
                                                           class="btn btn-sm btn-success ms-3">
                                                            Забронировать
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-calendar-x display-1 text-secondary"></i>
                    <h5 class="mt-3 fw-semibold">Нет бронирований</h5>
                    <p class="text-secondary mb-4">На {{ selected_date|date:"d.m.Y" }} в этом зале нет бронирований</p>
                    {% if user.role == 'requester' %}
                        <a href="{% url 'bookings:create_booking' %}?room={{ room.id }}&date={{ selected_date|date:'Y-m-d' }}" 
                           class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>
                            Забронировать
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Оснащение зала -->
<div class="row mt-4">
    <div class="col-12">
        <div class="border rounded-3 bg-white p-4">
            <h6 class="fw-medium mb-3">
                <i class="bi bi-tools text-primary me-2"></i>
                Оснащение зала
            </h6>
            <div class="d-flex flex-wrap gap-2">
                {% if room.has_projector %}
                    <span class="badge bg-light text-dark p-2">
                        <i class="bi bi-projector me-1"></i> Проектор
                    </span>
                {% endif %}
                {% if room.has_video_conference %}
                    <span class="badge bg-light text-dark p-2">
                        <i class="bi bi-camera-video me-1"></i> Видеоконференция
                    </span>
                {% endif %}
                {% if room.has_whiteboard %}
                    <span class="badge bg-light text-dark p-2">
                        <i class="bi bi-pencil-square me-1"></i> Магнитная доска
                    </span>
                {% endif %}
                {% if not room.has_projector and not room.has_video_conference and not room.has_whiteboard %}
                    <span class="text-secondary">Нет дополнительного оснащения</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}