{% extends 'bookings/base.html' %}
{% load static %}

{% block title %}Новая заявка {% endblock %}

{% block extra_css %}
<style>
    /* Временные слоты */
    .time-slots-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .time-slot {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 2rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        background-color: #ffffff;
        color: #1e293b;
    }

    .time-slot:hover {
        border-color: #3b82f6;
        background-color: #f8fafc;
    }

    .time-slot.available {
        background-color: #f0fdf4;
        border-color: #22c55e;
        color: #166534;
    }

    .time-slot.available:hover {
        background-color: #dcfce7;
    }

    .time-slot.past {
        background-color: #f1f5f9;
        border-color: #cbd5e1;
        color: #64748b;
        cursor: not-allowed;
        opacity: 0.6;
        text-decoration: line-through;
    }

    .time-slot.selected {
        background-color: #3b82f6;
        border-color: #3b82f6;
        color: #ffffff;
    }

    /* Информационные блоки */
    .info-card {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 1.25rem;
    }

    .info-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #475569;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-title i {
        color: #3b82f6;
    }

    /* Бейджи правил */
    .rule-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 2rem;
        font-size: 0.75rem;
        color: #475569;
    }

    .rule-badge i {
        color: #3b82f6;
        margin-right: 0.25rem;
    }

    /* Карточка зала в сайдбаре */
    .room-mini-card {
        padding: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
        transition: background-color 0.2s;
    }

    .room-mini-card:last-child {
        border-bottom: none;
    }

    .room-mini-card:hover {
        background-color: #f8fafc;
    }

    .room-mini-card .room-name {
        font-weight: 600;
        color: #0f172a;
    }

    .room-mini-card .room-details {
        font-size: 0.75rem;
        color: #64748b;
    }

    .equipment-badge {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        background-color: #f1f5f9;
        border-radius: 1rem;
        font-size: 0.7rem;
        color: #475569;
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Заголовок -->
<div class="row mb-4">
    <div class="col-12">
        <h2 class="fw-semibold">
            <i class="bi bi-plus-circle text-primary me-2"></i>
            Новая заявка на бронирование
        </h2>
        <p class="text-secondary">Заполните форму для создания заявки. Все поля обязательны для заполнения.</p>
    </div>
</div>

<!-- Информация о рабочем времени -->
<div class="row mb-4">
    <div class="col-12">
        <div class="info-card d-flex flex-wrap align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <i class="bi bi-clock-history fs-4 text-primary"></i>
                <div>
                    <span class="fw-medium">Режим работы:</span>
                    <span class="ms-2">{{ booking_settings.BOOKING_START_HOUR }}:00 – {{ booking_settings.BOOKING_END_HOUR }}:{{ booking_settings.BOOKING_END_MINUTE }}</span>
                </div>
            </div>
            <div class="d-flex gap-2 mt-2 mt-sm-0">
                <span class="rule-badge">
                    <i class="bi bi-hourglass-split"></i>
                    Мин. {{ booking_settings.MIN_BOOKING_DURATION }} мин
                </span>
                <span class="rule-badge">
                    <i class="bi bi-hourglass-top"></i>
                    Макс. {% widthratio booking_settings.MAX_BOOKING_DURATION 60 1 %} ч
                </span>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Основная форма -->
    <div class="col-lg-8">
        <div class="border rounded-3 bg-white p-4">
            <form method="post" id="bookingForm" novalidate>
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <div>
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <!-- Конференц-зал -->
                <div class="mb-4">
                    <label for="{{ form.room.id_for_label }}" class="form-label fw-medium">
                        Конференц-зал <span class="text-danger">*</span>
                    </label>
                    {{ form.room }}
                    {% if form.room.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.room.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Название мероприятия -->
                <div class="mb-4">
                    <label for="{{ form.title.id_for_label }}" class="form-label fw-medium">
                        Название мероприятия <span class="text-danger">*</span>
                    </label>
                    {{ form.title }}
                    {% if form.title.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.title.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Описание -->
                <div class="mb-4">
                    <label for="{{ form.description.id_for_label }}" class="form-label fw-medium">
                        Описание
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.description.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text">Опишите цель мероприятия, необходимые материалы и особые требования</div>
                </div>

                <!-- Дата и время -->
                <div class="row mb-4">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <label for="{{ form.start_time.id_for_label }}" class="form-label fw-medium">
                            Дата и время начала <span class="text-danger">*</span>
                        </label>
                        {{ form.start_time }}
                        {% if form.start_time.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.start_time.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Доступно с {{ booking_settings.BOOKING_START_HOUR }}:00</div>
                    </div>

                    <div class="col-md-6">
                        <label for="{{ form.end_time.id_for_label }}" class="form-label fw-medium">
                            Дата и время окончания <span class="text-danger">*</span>
                        </label>
                        {{ form.end_time }}
                        {% if form.end_time.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.end_time.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Не позднее {{ booking_settings.BOOKING_END_HOUR }}:{{ booking_settings.BOOKING_END_MINUTE }}</div>
                    </div>
                </div>

                <!-- Быстрый выбор времени -->
                <div class="mb-4">
                    <label class="form-label fw-medium">
                        Быстрый выбор времени (сегодня)
                    </label>
                    <div id="quickTimeSlots" class="time-slots-container">
                        <!-- Слоты будут добавлены через JavaScript -->
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Серым отмечены прошедшие слоты
                    </small>
                </div>

                <!-- Количество участников -->
                <div class="mb-4">
                    <label for="{{ form.participants_count.id_for_label }}" class="form-label fw-medium">
                        Количество участников <span class="text-danger">*</span>
                    </label>
                    {{ form.participants_count }}
                    {% if form.participants_count.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.participants_count.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Важная информация -->
                <div class="alert alert-info d-flex align-items-start mb-4" role="alert">
                    <i class="bi bi-info-circle-fill me-3 fs-5 flex-shrink-0"></i>
                    <div>
                        <strong class="d-block mb-2">Важно!</strong>
                        <ul class="mb-0 small">
                            <li>Нельзя забронировать на прошедшую дату</li>
                            <li>Бронирование только в рабочее время: {{ booking_settings.BOOKING_START_HOUR }}:00 – {{ booking_settings.BOOKING_END_HOUR }}:{{ booking_settings.BOOKING_END_MINUTE }}</li>
                            <li>После отправки заявка будет рассмотрена модератором</li>
                        </ul>
                    </div>
                </div>

                <!-- Кнопки -->
                <div class="d-flex gap-3">
                    <a href="{% url 'bookings:index' %}" class="btn btn-outline-secondary flex-fill py-2">
                        <i class="bi bi-x-lg me-2"></i>
                        Отмена
                    </a>
                    <button type="submit" class="btn btn-primary flex-fill py-2">
                        <i class="bi bi-check-lg me-2"></i>
                        Отправить заявку
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Боковая панель -->
    <div class="col-lg-4">
        <!-- Правила бронирования -->
        <div class="border rounded-3 bg-white p-4 mb-4">
            <div class="info-title">
                <i class="bi bi-info-circle"></i>
                Правила бронирования
            </div>
            <ul class="list-unstyled small vstack gap-2">
                <li class="d-flex align-items-center">
                    <i class="bi bi-x-circle-fill text-danger me-2"></i>
                    Нельзя бронировать на прошедшие даты
                </li>
                <li class="d-flex align-items-center">
                    <i class="bi bi-clock me-2 text-primary"></i>
                    Мин. время: {{ booking_settings.MIN_BOOKING_DURATION }} мин
                </li>
                <li>
                    <i class="bi bi-clock"></i>
                    Макс. время: {% widthratio booking_settings.MAX_BOOKING_DURATION 60 1 %} ч
                </li>
                <li class="d-flex align-items-center">
                    <i class="bi bi-calendar-range me-2 text-primary"></i>
                    Макс. срок: {{ booking_settings.MAX_ADVANCE_BOOKING_DAYS }} дней
                </li>
                <li class="d-flex align-items-center">
                    <i class="bi bi-alarm me-2 text-primary"></i>
                    Заявка минимум за {{ booking_settings.CANCELLATION_DEADLINE_HOURS }} часа
                </li>
            </ul>
        </div>

        <!-- Статусы заявок -->
        <div class="border rounded-3 bg-white p-4 mb-4">
            <div class="info-title">
                <i class="bi bi-tags"></i>
                Статусы заявок
            </div>
            <div class="vstack gap-2">
                <div class="d-flex align-items-center">
                    <span class="badge bg-warning me-2">Ожидает</span>
                    <span class="small text-secondary">На рассмотрении</span>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-2">Подтверждено</span>
                    <span class="small text-secondary">Бронирование подтверждено</span>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-danger me-2">Отклонено</span>
                    <span class="small text-secondary">Заявка отклонена</span>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-secondary me-2">Отменено</span>
                    <span class="small text-secondary">Заявка отменена</span>
                </div>
            </div>
        </div>

        <!-- Конференц-залы -->
        <div class="border rounded-3 bg-white">
            <div class="p-3 border-bottom bg-light">
                <span class="fw-medium">
                    <i class="bi bi-building me-2"></i>
                    Конференц-залы
                </span>
            </div>
            <div class="p-2">
                {% for room in rooms %}
                    <div class="room-mini-card">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="room-name">{{ room.name }}</span>
                            <span class="badge bg-primary">{{ room.capacity }} чел.</span>
                        </div>
                        <div class="room-details mb-2">
                            <i class="bi bi-geo-alt me-1"></i> {{ room.location }}
                        </div>
                        <div>
                            {% if room.has_projector %}
                                <span class="equipment-badge">
                                    <i class="bi bi-projector me-1"></i>Проектор
                                </span>
                            {% endif %}
                            {% if room.has_video_conference %}
                                <span class="equipment-badge">
                                    <i class="bi bi-camera-video me-1"></i>ВКС
                                </span>
                            {% endif %}
                            {% if room.has_whiteboard %}
                                <span class="equipment-badge">
                                    <i class="bi bi-pencil-square me-1"></i>Доска
                                </span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const startInput = document.getElementById('{{ form.start_time.id_for_label }}');
        const endInput = document.getElementById('{{ form.end_time.id_for_label }}');
        const roomSelect = document.getElementById('{{ form.room.id_for_label }}');

        // Получаем текущую дату и время
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();

        // Устанавливаем минимальную дату - сегодня
        startInput.min = now.toISOString().slice(0, 16);
        endInput.min = now.toISOString().slice(0, 16);

        // Добавление быстрых слотов времени (только будущие слоты)
        const quickSlots = document.getElementById('quickTimeSlots');
        const workingHours = [];

        // Создание слотов с 7:00 до 16:00 с шагом 30 минут
        for (let hour = 7; hour <= 15; hour++) {
            for (let minute of [0, 30]) {
                if (hour === 15 && minute === 30) continue;
                const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                workingHours.push(timeStr);
            }
        }
        workingHours.push('16:00');

        // Определяем, какие слоты уже прошли сегодня
        workingHours.forEach(time => {
            const [hours, minutes] = time.split(':').map(Number);
            const slotDateTime = new Date();
            slotDateTime.setHours(hours, minutes, 0, 0);

            const slot = document.createElement('span');

            // Проверяем, не прошло ли уже это время сегодня
            if (slotDateTime < now) {
                slot.className = 'time-slot past';
                slot.title = 'Это время уже прошло';
            } else {
                slot.className = 'time-slot available';
            }

            slot.textContent = time;

            if (slotDateTime >= now) {
                slot.onclick = function() {
                    if (startInput.value) {
                        const selectedDate = startInput.value.split('T')[0];
                        // Проверяем, не выбрана ли прошедшая дата
                        if (selectedDate < today) {
                            alert('Нельзя выбрать прошедшую дату!');
                            return;
                        }
                        startInput.value = `${selectedDate}T${time}`;

                        // Автоматически устанавливаем окончание через 1 час
                        let endHour = hours + 1;
                        let endMinute = minutes;

                        if (endHour === 16 && endMinute > 30) {
                            endHour = 16;
                            endMinute = 30;
                        }

                        if (endHour <= 16) {
                            endInput.value = `${selectedDate}T${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;
                        }
                    } else {
                        alert('Сначала выберите дату');
                    }
                };
            }

            quickSlots.appendChild(slot);
        });

        // Валидация при изменении даты
        startInput.addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            if (selectedDate < now) {
                alert('Ошибка: Нельзя выбрать прошедшую дату и время!');
                this.value = '';
            }
        });

        endInput.addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            if (selectedDate < now) {
                alert('Ошибка: Нельзя выбрать прошедшую дату и время!');
                this.value = '';
            }
        });

        // Проверка доступности при выборе зала и времени
        roomSelect.addEventListener('change', checkAvailability);
        startInput.addEventListener('change', checkAvailability);
        endInput.addEventListener('change', checkAvailability);

        function checkAvailability() {
            if (roomSelect.value && startInput.value && endInput.value) {
                const startDate = new Date(startInput.value);
                const endDate = new Date(endInput.value);

                // Проверка на прошедшие даты
                if (startDate < now || endDate < now) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-2';
                    alertDiv.innerHTML = `
                        <i class="bi bi-exclamation-triangle"></i>
                        Нельзя выбрать прошедшую дату!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;

                    const form = document.getElementById('bookingForm');
                    form.insertBefore(alertDiv, form.firstChild);

                    setTimeout(() => {
                        alertDiv.remove();
                    }, 5000);
                    return;
                }

                fetch(`/api/check-availability/?room_id=${roomSelect.value}&start_time=${startInput.value}&end_time=${endInput.value}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.available) {
                            let message = '';
                            if (data.conflicting) {
                                message = 'Это время уже занято';
                            } else if (!data.time_valid) {
                                message = data.time_message || 'Некорректное время';
                            }

                            if (message) {
                                const alertDiv = document.createElement('div');
                                alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-2';
                                alertDiv.innerHTML = `
                                    <i class="bi bi-exclamation-triangle"></i>
                                    ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                `;

                                const form = document.getElementById('bookingForm');
                                form.insertBefore(alertDiv, form.firstChild);

                                setTimeout(() => {
                                    alertDiv.remove();
                                }, 5000);
                            }
                        }
                    });
            }
        }
    });
</script>
{% endblock %}